-- =============================================================================
-- DOCTORSHAMI FULL DATABASE SCRIPT
-- Copy everything below and run in Supabase SQL Editor
-- =============================================================================

-- 1. SETUP EXTENSIONS & ENUMS
create extension if not exists "uuid-ossp";

DO $$ BEGIN
    create type user_role as enum ('ADMIN', 'PROVIDER', 'PATIENT');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- 2. STORAGE BUCKET & POLICIES (Fixes "Unauthorized" / "Violates RLS" errors)
-- Create bucket
insert into storage.buckets (id, name, public)
values ('docotrshami', 'docotrshami', true)
on conflict (id) do update set public = true;

-- Drop existing policies to ensure clean state
drop policy if exists "Public Access" on storage.objects;
drop policy if exists "Authenticated Upload" on storage.objects;
drop policy if exists "Owner Delete" on storage.objects;
drop policy if exists "Give me access" on storage.objects;
drop policy if exists "Public Read Access" on storage.objects;
drop policy if exists "Owner Manage" on storage.objects;

-- Create correct policies
create policy "Public Read Access"
on storage.objects for select
using ( bucket_id = 'docotrshami' );

create policy "Authenticated Upload"
on storage.objects for insert
to authenticated
with check ( bucket_id = 'docotrshami' );

create policy "Owner Manage"
on storage.objects for all
to authenticated
using ( bucket_id = 'docotrshami' and auth.uid() = owner );


-- 3. PROFILES TABLE
create table if not exists profiles (
  id uuid references auth.users on delete cascade not null primary key,
  full_name text not null,
  role user_role default 'PATIENT',
  phone text,
  password_plain text,
  avatar_url text,
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- Profiles RLS
alter table profiles enable row level security;
drop policy if exists "Public profiles are viewable by everyone." on profiles;
drop policy if exists "Users can insert their own profile." on profiles;
drop policy if exists "Users can update own profile." on profiles;

create policy "Public profiles are viewable by everyone." on profiles for select using (true);
create policy "Users can insert their own profile." on profiles for insert with check (auth.uid() = id);
create policy "Users can update own profile." on profiles for update using (auth.uid() = id);


-- 4. CITIES TABLE
create table if not exists cities (
  id bigint generated by default as identity primary key,
  name_en text not null,
  name_ar text not null
);

insert into cities (name_en, name_ar)
select 'Damascus', 'دمشق' where not exists (select 1 from cities where name_en = 'Damascus')
union all select 'Aleppo', 'حلب' where not exists (select 1 from cities where name_en = 'Aleppo')
union all select 'Homs', 'حمص' where not exists (select 1 from cities where name_en = 'Homs')
union all select 'Latakia', 'اللاذقية' where not exists (select 1 from cities where name_en = 'Latakia');


-- 5. SPECIALTIES TABLE
create table if not exists specialties (
  id bigint generated by default as identity primary key,
  name_en text not null,
  name_ar text not null
);

insert into specialties (name_en, name_ar)
select 'General', 'عام' where not exists (select 1 from specialties where name_en = 'General')
union all select 'Cardiology', 'قلبية' where not exists (select 1 from specialties where name_en = 'Cardiology')
union all select 'Dentistry', 'أسنان' where not exists (select 1 from specialties where name_en = 'Dentistry')
union all select 'Dermatology', 'جلدية' where not exists (select 1 from specialties where name_en = 'Dermatology')
union all select 'Pediatrics', 'أطفال' where not exists (select 1 from specialties where name_en = 'Pediatrics');


-- 6. CLINICS TABLE
create table if not exists clinics (
  id uuid default uuid_generate_v4() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name_en text not null,
  name_ar text not null,
  description text, 
  logo_url text,
  is_verified boolean default false,
  owner_id uuid references profiles(id) not null,
  location_en text,
  location_ar text,
  city_id bigint references cities(id),
  services text[],
  contact_phone text,
  category_id bigint references specialties(id)
);

-- IMPORTANT: Add Missing Columns (Fixes "Could not find description_ar" error)
alter table clinics add column if not exists description_en text;
alter table clinics add column if not exists description_ar text;
alter table clinics add column if not exists opening_hours jsonb default '{}'::jsonb;
alter table clinics add column if not exists category_ids bigint[] default '{}';

-- Create Index for multi-category search
create index if not exists clinics_category_ids_idx on clinics using gin (category_ids);

-- Clinics RLS
alter table clinics enable row level security;
drop policy if exists "Clinics viewable by everyone" on clinics;
drop policy if exists "Providers insert own clinics" on clinics;
drop policy if exists "Providers update own clinics" on clinics;
drop policy if exists "Providers delete own clinics" on clinics;

create policy "Clinics viewable by everyone" on clinics for select using (true);
create policy "Providers insert own clinics" on clinics for insert with check (auth.uid() = owner_id);
create policy "Providers update own clinics" on clinics for update using (auth.uid() = owner_id);
create policy "Providers delete own clinics" on clinics for delete using (auth.uid() = owner_id);


-- 7. DOCTORS TABLE
create table if not exists doctors (
    id uuid default uuid_generate_v4() primary key,
    clinic_id uuid references clinics(id) on delete cascade not null,
    name_en text not null,
    name_ar text not null,
    specialty_id bigint references specialties(id),
    bio text,
    photo_url text,
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Doctors RLS
alter table doctors enable row level security;
drop policy if exists "Doctors viewable by everyone" on doctors;
drop policy if exists "Providers manage doctors" on doctors;

create policy "Doctors viewable by everyone" on doctors for select using (true);
create policy "Providers manage doctors" on doctors for all using (
    exists (select 1 from clinics where id = doctors.clinic_id and owner_id = auth.uid())
);


-- 8. SCHEDULES TABLE
create table if not exists doctor_schedules (
    id uuid default uuid_generate_v4() primary key,
    doctor_id uuid references doctors(id) on delete cascade not null,
    day_of_week int not null, 
    start_time time not null,
    end_time time not null,
    slot_duration int default 30
);

-- Schedules RLS
alter table doctor_schedules enable row level security;
drop policy if exists "Schedules viewable by everyone" on doctor_schedules;
drop policy if exists "Providers manage schedules" on doctor_schedules;

create policy "Schedules viewable by everyone" on doctor_schedules for select using (true);
create policy "Providers manage schedules" on doctor_schedules for all using (
    exists (select 1 from doctors d join clinics c on d.clinic_id = c.id where d.id = doctor_schedules.doctor_id and c.owner_id = auth.uid())
);


-- 9. PHARMACIES TABLE
create table if not exists pharmacies (
  id uuid default uuid_generate_v4() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name_en text not null,
  name_ar text not null,
  owner_id uuid references profiles(id) not null,
  location_en text,
  location_ar text,
  city_id bigint references cities(id)
);

-- Pharmacies RLS
alter table pharmacies enable row level security;
drop policy if exists "Pharmacies viewable by everyone" on pharmacies;
drop policy if exists "Providers manage pharmacies" on pharmacies;

create policy "Pharmacies viewable by everyone" on pharmacies for select using (true);
create policy "Providers manage pharmacies" on pharmacies for all using (auth.uid() = owner_id);


-- 10. BOOKINGS TABLE
create table if not exists bookings (
  id uuid default uuid_generate_v4() primary key,
  clinic_id uuid references clinics(id) on delete cascade not null,
  doctor_id uuid references doctors(id),
  patient_id uuid references profiles(id) not null,
  booking_date timestamp with time zone not null,
  status text default 'PENDING',
  notes text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Bookings RLS
alter table bookings enable row level security;
drop policy if exists "View own bookings" on bookings;
drop policy if exists "Patients insert bookings" on bookings;
drop policy if exists "Update bookings" on bookings;

create policy "View own bookings" on bookings for select using (
  auth.uid() = patient_id OR 
  auth.uid() IN (select owner_id from clinics where id = bookings.clinic_id)
);

create policy "Patients insert bookings" on bookings for insert with check (auth.uid() = patient_id);

create policy "Update bookings" on bookings for update using (
   auth.uid() = patient_id OR 
   auth.uid() IN (select owner_id from clinics where id = bookings.clinic_id)
);

create index if not exists bookings_date_idx on bookings(booking_date);
